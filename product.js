const currentProduct = {
	"partuid": 112304677071,
	"product": {
		"uid": "308764954891",
		"rootpartid": "5812672",
		"title": "Russian Food",
		"descr": "<ul><li>Гречка, грибы, шпинат, брокколи, стейк из куриной грудки, помидоры черри, овечья брынза</li><li>Жиры 28,7</li><li>Белки 31,3</li><li>Углеводы 37,9</li><li>150/50/70/60 — <strong>358,28 kcal</strong></li></ul>",
		"sku": "Russian Food",
		"price": "80.0000",
		"gallery": "[{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3665-6662-4633-b565-656639343533\\/food-5.png\"},{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3032-6533-4139-a362-306435666537\\/image.png\"}]",
		"sort": "1000000",
		"portion": "0",
		"newsort": "0",
		"json_chars": "null",
		"externalid": "GIdOg1d3YTstOjBLlc2y",
		"pack_label": "lwh",
		"pack_x": "0",
		"pack_y": "0",
		"pack_z": "0",
		"pack_m": "0",
		"prod_option": "Первое блюдо:",
		"prod_variants": "Не выбрано\nСуп-крем Томатный 30 MDL=+30\nСуп-крем Сливочный 30 MDL=+30",
		"parentuid": "",
		"editions": [{
			"uid": "308764954891",
			"price": "80.0000",
			"priceold": "",
			"sku": "Russian Food",
			"quantity": "",
			"img": "https://static.tildacdn.com/tild3665-6662-4633-b565-656639343533/food-5.png"
		}],
		"characteristics": []
	}
}

const otherProduct = {
	"partuid": 112304677071,
	"relevants": [{
			"uid": "332995285241",
			"title": "Chicken Bowl",
			"sku": "Chicken Bowl",
			"text": "",
			"mark": "",
			"quantity": "",
			"portion": "0",
			"unit": "",
			"single": "",
			"price": "80.0000",
			"priceold": "",
			"descr": "<ul><li>Киноа с булгуром, грибы, бобы эдамаме, куриный стейк, шпинат, помидоры черри, овкчья брынза, куриное яйцо, листья салата</li><li>Жиры 24,9</li><li>Белки 18,0</li><li>Углеводы 33,9</li><li>200/50/30 — <strong>481,85 kcal</strong></li></ul>",
			"gallery": "[{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3665-6662-4633-b565-656639343533\\/food-5.png\"},{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3534-3532-4735-a262-333839323232\\/vega-1_1.png\"}]",
			"buttonlink": "",
			"buttontarget": "",
			"json_options": "",
			"sort": "1000437",
			"url": "http://andys-lunch.tilda.ws/tproduct/332450804-332995285241-chicken-bowl",
			"pack_label": "lwh",
			"pack_x": "0",
			"pack_y": "0",
			"pack_z": "0",
			"pack_m": "0",
			"partuids": "[\"112304677071\"]",
			"externalid": "iHs4NLNJlBg3yUndRMRm",
			"prod_option": "Первое блюдо",
			"prod_variants": "Не выбрано\nСуп-крем Томатный 30 MDL=+30\nСуп-крем Сливочный 30 MDL=+30",
			"editions": [{
				"uid": "332995285241",
				"price": "80.0000",
				"priceold": "",
				"sku": "Chicken Bowl",
				"quantity": "",
				"img": "https://static.tildacdn.com/tild3665-6662-4633-b565-656639343533/food-5.png"
			}],
			"characteristics": []
		},
		{
			"uid": "350375597481",
			"title": "Chicken Fagitas",
			"sku": "Chicken Fagitas",
			"text": "",
			"mark": "",
			"quantity": "",
			"portion": "0",
			"unit": "",
			"single": "",
			"price": "80.0000",
			"priceold": "",
			"descr": "<ul><li>Тортильи, куриный стейк, салат айсберг, сыр, печеный перец, оливковое масло, помидоры черри, шпинат, соус дзадзики</li><li>Жиры 26,7</li><li>Белки 28,8</li><li>Углеводы 26,52</li><li>200/65/50 — <strong>464,01 kcal</strong></li></ul>",
			"gallery": "[{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3665-6662-4633-b565-656639343533\\/food-5.png\"},{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3038-6362-4331-b332-393562386330\\/image.png\"}]",
			"buttonlink": "",
			"buttontarget": "",
			"json_options": "",
			"sort": "1000250",
			"url": "http://andys-lunch.tilda.ws/tproduct/332450804-350375597481-chicken-fagitas",
			"pack_label": "lwh",
			"pack_x": "0",
			"pack_y": "0",
			"pack_z": "0",
			"pack_m": "0",
			"partuids": "[\"112304677071\"]",
			"externalid": "6Z4Pj9rVfOdhddTB5UuT",
			"prod_option": "Первое блюдо:",
			"prod_variants": "Не выбрано\nСуп-крем Томатный 30 MDL=+30\nСуп-крем Сливочный 30 MDL=+30",
			"editions": [{
				"uid": "350375597481",
				"price": "80.0000",
				"priceold": "",
				"sku": "Chicken Fagitas",
				"quantity": "",
				"img": "https://static.tildacdn.com/tild3665-6662-4633-b565-656639343533/food-5.png"
			}],
			"characteristics": []
		},
		{
			"uid": "406679961761",
			"title": "Fish Teriaki",
			"sku": "Fish Teriaki",
			"text": "",
			"mark": "",
			"quantity": "",
			"portion": "0",
			"unit": "",
			"single": "",
			"price": "80.0000",
			"priceold": "",
			"descr": "<ul><li>Киноа с булгуром, брокколи, бобы эдамаме, лосось, перепелиные яйца, кунжут, лимон, помидоры черри, шпинат</li><li>Жиры 13,0</li><li>Белки 28,8</li><li>Углеводы 40,9</li><li>250/65/40 — <strong>472,22 kcal</strong></li></ul>",
			"gallery": "[{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3665-6662-4633-b565-656639343533\\/food-5.png\"},{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3534-3532-4735-a262-333839323232\\/vega-1_1.png\"}]",
			"buttonlink": "",
			"buttontarget": "",
			"json_options": "",
			"sort": "1002000",
			"url": "http://andys-lunch.tilda.ws/tproduct/332450804-406679961761-fish-teriaki",
			"pack_label": "lwh",
			"pack_x": "0",
			"pack_y": "0",
			"pack_z": "0",
			"pack_m": "0",
			"partuids": "[\"112304677071\"]",
			"externalid": "DZItkEzjaAhM74tHn67L",
			"prod_option": "Первое блюдо",
			"prod_variants": "Не выбрано\nСуп-крем Томатный 30 MDL=+30\nСуп-крем Сливочный 30 MDL=+30",
			"editions": [{
				"uid": "406679961761",
				"price": "80.0000",
				"priceold": "",
				"sku": "Fish Teriaki",
				"quantity": "",
				"img": "https://static.tildacdn.com/tild3665-6662-4633-b565-656639343533/food-5.png"
			}],
			"characteristics": []
		},
		{
			"uid": "356094163001",
			"title": "Greek Chicken",
			"sku": "Greek Chicken",
			"text": "",
			"mark": "",
			"quantity": "",
			"portion": "0",
			"unit": "",
			"single": "",
			"price": "80.0000",
			"priceold": "",
			"descr": "<ul><li>Лист салата, шпинат, салат айсберг, помидоры черри, оливки, куриный стейк, соус дзадзики, виноград</li><li>Жиры 34,7</li><li>Белки 21,4</li><li>Углеводы 22,2</li><li>90/70/50/80 — <strong>475,3 kcal</strong></li></ul>",
			"gallery": "[{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3665-6662-4633-b565-656639343533\\/food-5.png\"},{\"img\":\"https:\\/\\/static.tildacdn.com\\/tild3534-3532-4735-a262-333839323232\\/vega-1_1.png\"}]",
			"buttonlink": "",
			"buttontarget": "",
			"json_options": "",
			"sort": "1000375",
			"url": "http://andys-lunch.tilda.ws/tproduct/332450804-356094163001-greek-chicken",
			"pack_label": "lwh",
			"pack_x": "0",
			"pack_y": "0",
			"pack_z": "0",
			"pack_m": "0",
			"partuids": "[\"112304677071\"]",
			"externalid": "xaEX0uuSc64dPFOZVxfN",
			"prod_option": "Первое блюдо",
			"prod_variants": "Не выбрано\nСуп-крем Томатный 30 MDL=+30\nСуп-крем Сливочный 30 MDL=+30",
			"editions": [{
				"uid": "356094163001",
				"price": "80.0000",
				"priceold": "",
				"sku": "Greek Chicken",
				"quantity": "",
				"img": "https://static.tildacdn.com/tild3665-6662-4633-b565-656639343533/food-5.png"
			}],
			"characteristics": []
		}
	]
}

window.addEventListener('DOMContentLoaded', () => {

	// window.history.pushState('', 'New Page Title', '#!/tproduct/332450804-308764954891');
	// https://store.tildacdn.com/api/getproduct/?storepartuid=112304677071&productuid=356094163001
	// https://store.tildacdn.com/api/getrelevantproducts/?storepartuid=112304677071&productuid=356094163001
	
	try{
		document.querySelector('.js-store-product').remove()
	} catch(e){}

	const href = window.location.href;
	const productID = []
	const regex = href.split('/');

	const gramm = () => { 
		if (lang != 'ru') {
			return 'gram'
		} else {
			return "грамм"
		}
	}

	const addToCartBtnText = () => {
		if (lang == 'ru') {
			return 'Заказать'
		} else if (lang == 'ro') {
			return "În coș"
		} else {
			return "Order"
		}
	}

	const recomandTitle = () => {
		if (lang === 'ru') {
			return "Также рекомендуем"
		} else if ( lang === 'ro') {
			return 'Vă recomandăm'
		} else {
			return "We also recommend"
		}
	}
 
	async function getDataProduct(url) { 
	const request = await window.fetch(url) 
		if (request.status === 200) {
				const data =  await request.text()
				return data   
		}  
	}
	
	if (regex[3] === 'tproduct') {
			productID.push(regex[4].split('-')[1]) 
	}
	
	const prodLink = `https://store.tildacdn.com/api/getproduct/?storepartuid=112304677071&productuid=${productID}`
	
	console.log(`ProdLink: ${prodLink}`)

	getDataProduct(prodLink).then(data => {
		return  JSON.parse(data); 
	}).then(data => { 
		console.log(data)
	})
 
	const mainProdWraper = document.querySelector('#rec332450804');
	mainProdWraper.classList.add('main')
 
	const currentProductImg = JSON.parse(currentProduct.product.gallery)[1].img
	const currentProductTitle = currentProduct.product.title.split(" ")
	const currentProductDescr = currentProduct.product.descr.replace(/[<\/]+(strong)>|[<\/]+(ul)>|<li>/gm, "").split(/<\/li>/);
	const currentProductWeight = currentProductDescr[4].split('—').map(elem => elem.trim())
	const allWeight = currentProductWeight[0]
	const kcal = currentProductWeight[1]
	const fatTitle = currentProductDescr[1].split(" ")[0]
	const fatQuant = currentProductDescr[1].split(" ")[1]

	const proteinTitle = currentProductDescr[2].split(" ")[0]
	const proteinQuant = currentProductDescr[2].split(" ")[1]

	const carbsTitle = currentProductDescr[3].split(" ")[0]
	const carbsQuant = currentProductDescr[3].split(" ")[1]

	const currentOpriontTitle = currentProduct.product.prod_option
	
	const lang = navigator.language


	const prodOption = []
	const option = () => {
		currentProduct.product.prod_variants.split("\n").map(elem => {
			const newOption = document.createElement('option')
			const elemInfo = elem.split("=")

			newOption.setAttribute('value', elemInfo[0])
			newOption.setAttribute('data-product-variant-price', elemInfo[1] || 'undefined')
			newOption.innerText = elemInfo[0] || elem

			prodOption.push(newOption)
			return elem
		})
	};
	option() 

	
	const mainProduct = document.createElement('div')
	mainProduct.classList.add('prod', 'js-store-product', 'js-product', 't-store__product-snippet')
	mainProduct.setAttribute('data-product-lid', currentProduct.product.uid)
	mainProduct.setAttribute('data-product-uid', currentProduct.product.uid)
	mainProduct.setAttribute('data-product-img', currentProductImg)
	mainProduct.setAttribute('data-product-inv', null)
 
	mainProduct.innerHTML = ` 
 
	<meta itemprop="productID" content="${currentProduct.product.uid}">
	<div class="wrapper">
		<div class="prod_wrapper">
			<img src="${currentProductImg}" alt="${currentProduct.product.title}" class="prod_img js-store-prod-slider">
			<div class="prod_wrapper_text">

				<div class="prod_wrapper_text_subtitle">Классический ланч</div>
				<div class="t-store__prod-popup__title-wrapper"> 
					<h1 class="js-store-prod-name js-product-name t-store__prod-popup__name t-name t-name_xl prod_wrapper_text_title" itemprop="name"
						>${currentProductTitle[0]} <em>${currentProductTitle[1]}</em></h1>
					<div class="t-store__prod-popup__brand t-descr t-descr_xxs" style="display: none;">
					</div>
					<div class="t-store__prod-popup__sku t-descr t-descr_xxs" style="display: none;">
						SKU: <span class="js-store-prod-sku js-product-sku " itemprop="sku">${currentProduct.product.sku}</span>
					</div>
				</div>
				<div class="prod_wrapper_text_weight">${allWeight} — <strong>${kcal}</strong> <span class="info">i</span></div>
				<div class="prod_wrapper_text_descr">${currentProductDescr[0]}</div>
			</div>
			<div class="prod_wrapper_info">
 

				<div class="prod_wrapper_info_weight">
					<div class="prod_wrapper_info_weight_units">
						<div class="prod_wrapper_info_weight_title">${fatTitle}</div>
						<div class="prod_wrapper_info_weight_numbers">${fatQuant}</div>
						<div class="prod_wrapper_info_weight_grams">${gramm()}</div>
					</div>
					<div class="prod_wrapper_info_weight_units">
						<div class="prod_wrapper_info_weight_title">${proteinTitle}</div>
						<div class="prod_wrapper_info_weight_numbers">${proteinQuant}</div>
						<div class="prod_wrapper_info_weight_grams">${gramm()}</div>
					</div>
					<div class="prod_wrapper_info_weight_units">
						<div class="prod_wrapper_info_weight_title">${carbsTitle}</div>
						<div class="prod_wrapper_info_weight_numbers">${carbsQuant}</div>
						<div class="prod_wrapper_info_weight_grams">${gramm()}</div>
					</div>
				</div>
 
				<div class="js-product-controls-wrapper t-store__card__prod-controls-wrapper prod_wrapper_info_select">
					<div class="js-product-option t-product__option">
						<div class="js-product-option-name t-product__option-title t-descr t-descr_xxs prod_wrapper_info_select_title">${currentOpriontTitle}</div>
						<div class="t-product__option-variants t-product__option-variants_regular">
							<select class="js-product-option-varian ts t-product__option-select t-descr t-descr_xxs">
								
							</select>
						</div> 
					</div>  
				</div>
 
				<div class="prod_wrapper_info_btns js-store-price-wrapper "> 
					<div class="js-store-price-wrapper  prod_wrapper_info_btns_price">
						<div class=" js-product-price js-store-prod-price-val" 
							data-product-price-def="${parseInt(currentProduct.product.editions[0].price)}"
							data-product-price-def-str="${parseInt(currentProduct.product.editions[0].price)}"
						> ${parseInt(currentProduct.product.editions[0].price)} </div> 
						<div class="t-store__card__price-currency" style="margin-left: 4px;">MDL</div> 
					</div>
					<a href="#order">${addToCartBtnText()}</a>
				</div>
 
			</div>

		</div>
	</div>  
	`
	// Creating SVG and path elements and insert to DOM 

	const svgNS = 'http://www.w3.org/2000/svg';
	const svgEl = document.createElementNS(svgNS, 'svg');
	const pathEl = document.createElementNS(svgNS, 'circle');

	svgEl.setAttribute('xmlns', svgNS); 
	svgEl.appendChild(pathEl);
 
	mainProdWraper.append(svgEl);
 
	mainProdWraper.append(mainProduct);  
	mainProduct.querySelector('select').append(...prodOption)

	const mainBg = document.createElement('div')
	mainBg.classList.add('main-bg')
	mainProdWraper.append(mainBg); 
 
	const tStoreRelevantContainer = document.createElement('div')
	tStoreRelevantContainer.classList.add('t-store__relevants__container');

	mainProdWraper.appendChild(tStoreRelevantContainer)

	const recomand = document.createElement('div')
	recomand.classList.add('recomand','r');

	mainProdWraper.insertAdjacentElement('afterend', recomand)

	recomand.innerHTML = `
		<div class="recomand_title">
			${recomandTitle()}
		</div>
	`;

	const recomandWrapper = document.createElement('div')
	recomandWrapper.classList.add('recomand_wrapper')

	recomand.appendChild(recomandWrapper)

	otherProduct.relevants.forEach(data => {

		const product = document.createElement('div'); 
		const text = data.descr
			.replace(/[</]+(strong)>|[</]+(ul)>|<li>/gi, "") 
			.split(/<\/li>/); 

		const img = JSON.parse(data.gallery) 
			
		const dataProductLid =  data.uid; //elem.getAttribute('data-product-lid');
		const dataProductUid = data.uid; //elem.getAttribute('data-product-uid');
		const dataProductGenUid = data.uid; //elem.getAttribute('data-product-gen-uid');
		const jsProductSku = data.sku; //elem.querySelector('.js-store-prod-sku').getAttribute('field');

		const prodOptionTitle = data.prod_option;
		const productOptions = data.prod_variants;
		const options = productOptions.split('\n');

		const prodOption = []
		const setOptions = () => {
			options.map(elem => {
				const newOption = document.createElement('option')
				const elemInfo = elem.split("=")
	
				newOption.setAttribute('value', elemInfo[0])
				newOption.setAttribute('data-product-variant-price', elemInfo[1] || "")
				newOption.innerText = elemInfo[0] || elem
	
				prodOption.push(newOption)
				return elem
			})
		};
		setOptions() 
 
		const btnText = addToCartBtnText();
		const productSubtitle = 'Классический ланч';
		const title = data.title;
		const price = data.price.split('.')[0];
 
		product.classList.add('food', 'js-product');
		product.setAttribute('data-product-img', img[0].img);
		product.setAttribute('data-product-inv', dataProductUid);
		product.setAttribute('data-product-lid', dataProductLid);
		product.setAttribute('data-product-gen-uid', dataProductGenUid);
		product.setAttribute('data-product-url', data.url);

		product.innerHTML = `
			<div class='food_redline'> </div>
			<div class="food_img js-product-img" >
					<img src=${img[0].img} alt="${title}">
			</div>
			<div class="food_block"> 
				<div class="food_block_descr">${productSubtitle}</div>
				<div class="food_block_title js-store-prod-name js-product-name">${title}</div>
				<div class="t-store__card__sku t-descr t-descr_xxs" style=" display:none; ">SKU: 
				<span class="js-store-prod-sku js-product-sku" field="st_sku__${jsProductSku}" data-redactor-toolbar="no">${jsProductSku}</span></div>
				
				<div class="food_block_info">
					<div class="food_block_info_elem">
						<div class="food_block_info_elem_title">${text[1].split(' ')[0]}</div>
						<div class="food_block_info_elem_numbers">${text[1].split(' ')[1]}</div>
						<div class="food_block_info_elem_descr">${gramm()}</div>
					</div>
					<div class="food_block_info_elem">
						<div class="food_block_info_elem_title">${text[2].split(' ')[0]}</div>
						<div class="food_block_info_elem_numbers">${text[2].split(' ')[1]}</div>
						<div class="food_block_info_elem_descr">${gramm()}</div>
					</div>
					<div class="food_block_info_elem">
						<div class="food_block_info_elem_title">${text[3].split(' ')[0]}</div>
						<div class="food_block_info_elem_numbers"> ${text[3].split(' ')[1]}</div>
						<div class="food_block_info_elem_descr">${gramm()}</div>
					</div>
				</div>
				<div class="food_block_grams">${text[4].split("—")[0]} — <strong>${text[4].split("—")[1]}</strong><span class="info">i</span></div>
				<div class="food_block_text"> ${text[0]} </div>
				
				<div class="js-product-controls-wrapper t-store__card__prod-controls-wrapper prod_wrapper_info_select">
				<div class="js-product-option t-product__option">
					<div class="js-product-option-name t-product__option-title t-descr t-descr_xxs prod_wrapper_info_select_title">${prodOptionTitle}</div>
					<div class="t-product__option-variants t-product__option-variants_regular">
						<select class="js-product-option-varian ts t-product__option-select t-descr t-descr_xxs">
							
						</select>
					</div> 
				</div>  
			</div> 
				<div class="food_block_price js-store-price-wrapper">
					<div class="js-store-price-wrapper food_block_price_wrapper"> 
						<div class=" js-product-price js-store-prod-price-val" data-product-price-def="${price}" data-product-price-def-str="${price}">${price} </div>
						<div class="t-store__card__price-currency" style="margin-left: 4px;">MDL</div>
					</div>
					<a href="#order">${btnText}</a>
				</div>
			</div> 
			`; 
		recomandWrapper.append(product);
		product.querySelector('select').append(...prodOption)
 

	})

	document.querySelectorAll('.js-product-controls-wrapper')
	.forEach(option => {
		option.addEventListener('change', function(e){
		
				const priceBtn = this.nextElementSibling.querySelector('.js-product-price');
				const initialPrice = +priceBtn.getAttribute('data-product-price-def-str'); 
				const optionPrice = +e.target.value.replace(/\D/gi, "");
				
				priceBtn.setAttribute('data-product-price-def', initialPrice + optionPrice);
				priceBtn.innerText = initialPrice + optionPrice; 
		}) 
	})

	function hide(selector){ 
		
		document.querySelectorAll(selector).forEach(elem => { 
			elem.style.height = `0px` 
			elem.nextElementSibling.style.marginTop = '0px'
			try{
				elem.nextElementSibling.lastChild.classList.remove('info_clicked')
			} catch(e){}

		})
	}

	function show(selector, index){ 
		const wightInfoBLocks = document.querySelectorAll(selector)
		const wightInfoBLocksHeight = window.getComputedStyle(wightInfoBLocks[0])
		
		wightInfoBLocks[index].style.height = '70px'
		wightInfoBLocks[index].nextElementSibling.style.marginTop = '20px'
	}

	const foodCards = document.querySelectorAll('.food')
	
	foodCards.forEach((card, index) => {
		hide('.food_block_info')

		card.addEventListener('click', function(e) {  
			
			if (e.target.classList.contains('info_clicked') && e.target.nodeName == "SPAN" ) {
 
				hide('.food_block_info')
				e.target.classList.remove('info_clicked') 

			} else if (e.target.classList.contains('info') && e.target.nodeName == "SPAN" ) {
  
				hide('.food_block_info')
				e.target.classList.add('info_clicked')
				show('.food_block_info', index) 
			} 
		})
	})

	const mainFood = document.querySelector('.prod_wrapper')

	if (window.innerWidth < 1201) {
		mainFood.querySelector('.prod_wrapper_info_weight').style.height = '0px'
	}

	window.addEventListener('resize', () => {
		if (window.innerWidth < 1201) {
			mainFood.querySelector('.prod_wrapper_info_weight').style.height = '0px'
		} else {
			mainFood.querySelector('.prod_wrapper_info_weight').style.height = ''
		}
	})

	mainFood.querySelector('.info').addEventListener('click', function(e){
		if (e.target.classList.contains('info_clicked') && e.target.nodeName == "SPAN" ) {
 
			mainFood.querySelector('.prod_wrapper_info_weight').style.height = '0px'
			mainFood.querySelector('.prod_wrapper_info_weight').style.margin = '0px'
			e.target.classList.remove('info_clicked') 

		} else if (e.target.classList.contains('info') && e.target.nodeName == "SPAN" ) {

			hide('.food_block_info')
			e.target.classList.add('info_clicked')
			mainFood.querySelector('.prod_wrapper_info_weight').style.height = '70px'
			mainFood.querySelector('.prod_wrapper_info_weight').style.margin = '8px 0px'
		} 
	})

})

